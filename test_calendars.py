import datetime

from dateutil.relativedelta import relativedelta

from calendars import HolidayCalendar, HolidayCalendarType


class CalData(object):
    def __init__(self, cal_type: HolidayCalendarType):
        self._type = cal_type

        self.usny = {2008: [(1, 1), (1, 21), (2, 18), (5, 26), (7, 4), (9, 1), (10, 13), (11, 11), (11, 27), (12, 25)],
                     2009: [(1, 1), (1, 19), (2, 16), (5, 25), (7, 4), (9, 7), (10, 12), (11, 11), (11, 26), (12, 25)],
                     2010: [(1, 1), (1, 18), (2, 15), (5, 31), (7, 5), (9, 6), (10, 11), (11, 11), (11, 25), (12, 25)],
                     2011: [(1, 1), (1, 17), (2, 21), (5, 30), (7, 4), (9, 5), (10, 10), (11, 11), (11, 24), (12, 26)],
                     2012: [(1, 2), (1, 16), (2, 20), (5, 28), (7, 4), (9, 3), (10, 8), (11, 12), (11, 22), (12, 25)],
                     2013: [(1, 1), (1, 21), (2, 18), (5, 27), (7, 4), (9, 2), (10, 14), (11, 11), (11, 28), (12, 25)],
                     2014: [(1, 1), (1, 20), (2, 17), (5, 26), (7, 4), (9, 1), (10, 13), (11, 11), (11, 27), (12, 25)],
                     2015: [(1, 1), (1, 19), (2, 16), (5, 25), (7, 4), (9, 7), (10, 12), (11, 11), (11, 26), (12, 25)],
                     2021: [(1, 1), (1, 18), (2, 15), (5, 31), (7, 5), (9, 6), (10, 11), (11, 11), (11, 25), (12, 25)],
                     2022: [(1, 1), (1, 17), (2, 21), (5, 30), (6, 20), (7, 4), (9, 5), (10, 10), (11, 11), (11, 24),
                            (12, 26)]}

        self.usgs = {
            1996: [(1, 1), (1, 15), (2, 19), (4, 5), (5, 27), (7, 4), (9, 2), (10, 14), (11, 11), (11, 28), (12, 25)],
            1997: [(1, 1), (1, 20), (2, 17), (3, 28), (5, 26), (7, 4), (9, 1), (10, 13), (11, 11), (11, 27), (12, 25)],
            1998: [(1, 1), (1, 19), (2, 16), (4, 10), (5, 25), (7, 3), (9, 7), (10, 12), (11, 11), (11, 26), (12, 25)],
            1999: [(1, 1), (1, 18), (2, 15), (4, 2), (5, 31), (7, 5), (9, 6), (10, 11), (11, 11), (11, 25), (12, 24)],
            2000: [(1, 17), (2, 21), (4, 21), (5, 29), (7, 4), (9, 4), (10, 9), (11, 23), (12, 25)],
            2001: [(1, 1), (1, 15), (2, 19), (4, 13), (5, 28), (7, 4), (9, 3), (10, 8), (11, 12), (11, 22), (12, 25)],
            2002: [(1, 1), (1, 21), (2, 18), (3, 29), (5, 27), (7, 4), (9, 2), (10, 14), (11, 11), (11, 28), (12, 25)],
            2003: [(1, 1), (1, 20), (2, 17), (4, 18), (5, 26), (7, 4), (9, 1), (10, 13), (11, 11), (11, 27), (12, 25)],
            2004: [(1, 1), (1, 19), (2, 16), (4, 9), (5, 31), (7, 5), (9, 6), (10, 11), (11, 11), (11, 25), (12, 24)],
            2005: [(1, 17), (2, 21), (3, 25), (5, 30), (7, 4), (9, 5), (10, 10), (11, 11), (11, 24), (12, 26)],
            2006: [(1, 2), (1, 16), (2, 20), (4, 14), (5, 29), (7, 4), (9, 4), (10, 9), (11, 23), (12, 25)],
            2007: [(1, 1), (1, 15), (2, 19), (4, 6), (5, 28), (7, 4), (9, 3), (10, 8), (11, 12), (11, 22), (12, 25)],
            2008: [(1, 1), (1, 21), (2, 18), (3, 21), (5, 26), (7, 4), (9, 1), (10, 13), (11, 11), (11, 27), (12, 25)],
            2009: [(1, 1), (1, 19), (2, 16), (4, 10), (5, 25), (7, 3), (9, 7), (10, 12), (11, 11), (11, 26), (12, 25)],
            2010: [(1, 1), (1, 18), (2, 15), (4, 2), (5, 31), (7, 5), (9, 6), (10, 11), (11, 11), (11, 25), (12, 24)],
            2011: [(1, 17), (2, 21), (4, 22), (5, 30), (7, 4), (9, 5), (10, 10), (11, 11), (11, 24), (12, 26)],
            2012: [(1, 2), (1, 16), (2, 20), (4, 6), (5, 28), (7, 4), (9, 3), (10, 8), (10, 30), (11, 12), (11, 22),
                   (12, 25)],
            2013: [(1, 1), (1, 21), (2, 18), (3, 29), (5, 27), (7, 4), (9, 2), (10, 14), (11, 11), (11, 28), (12, 25)],
            2014: [(1, 1), (1, 20), (2, 17), (4, 18), (5, 26), (7, 4), (9, 1), (10, 13), (11, 11), (11, 27), (12, 25)],
            2015: [(1, 1), (1, 19), (2, 16), (4, 3), (5, 25), (7, 3), (9, 7), (10, 12), (11, 11), (11, 26), (12, 25)]}

        self.nyfd = {2003: [(1, 1), (1, 20), (2, 17), (5, 26), (7, 4), (9, 1), (10, 13), (11, 11), (11, 27), (12, 25)],
                     2004: [(1, 1), (1, 19), (2, 16), (5, 31), (7, 5), (9, 6), (10, 11), (11, 11), (11, 25)],
                     2005: [(1, 17), (2, 21), (5, 30), (7, 4), (9, 5), (10, 10), (11, 11), (11, 24), (12, 26)],
                     2006: [(1, 2), (1, 16), (2, 20), (5, 29), (7, 4), (9, 4), (10, 9), (11, 23), (12, 25)],
                     2007: [(1, 1), (1, 15), (2, 19), (5, 28), (7, 4), (9, 3), (10, 8), (11, 12), (11, 22), (12, 25)],
                     2008: [(1, 1), (1, 21), (2, 18), (5, 26), (7, 4), (9, 1), (10, 13), (11, 11), (11, 27), (12, 25)],
                     2009: [(1, 1), (1, 19), (2, 16), (5, 25), (9, 7), (10, 12), (11, 11), (11, 26), (12, 25)],
                     2010: [(1, 1), (1, 18), (2, 15), (5, 31), (7, 5), (9, 6), (10, 11), (11, 11), (11, 25)],
                     2011: [(1, 17), (2, 21), (5, 30), (7, 4), (9, 5), (10, 10), (11, 11), (11, 24), (12, 26)],
                     2012: [(1, 2), (1, 16), (2, 20), (5, 28), (7, 4), (9, 3), (10, 8), (11, 12), (11, 22), (12, 25)],
                     2013: [(1, 1), (1, 21), (2, 18), (5, 27), (7, 4), (9, 2), (10, 14), (11, 11), (11, 28), (12, 25)],
                     2014: [(1, 1), (1, 20), (2, 17), (5, 26), (7, 4), (9, 1), (10, 13), (11, 11), (11, 27), (12, 25)],
                     2015: [(1, 1), (1, 19), (2, 16), (5, 25), (9, 7), (10, 12), (11, 11), (11, 26), (12, 25)],
                     2016: [(1, 1), (1, 18), (2, 15), (5, 30), (7, 4), (9, 5), (10, 10), (11, 11), (11, 24), (12, 26)],
                     2017: [(1, 2), (1, 16), (2, 20), (5, 29), (7, 4), (9, 4), (10, 9), (11, 23), (12, 25)],
                     2018: [(1, 1), (1, 15), (2, 19), (5, 28), (7, 4), (9, 3), (10, 8), (11, 12), (11, 22), (12, 25)]}

        self.nyse = {2008: [(1, 1), (1, 21), (2, 18), (3, 21), (5, 26), (7, 4), (9, 1), (11, 27), (12, 25)],
                     2009: [(1, 1), (1, 19), (2, 16), (4, 10), (5, 25), (7, 3), (9, 7), (11, 26), (12, 25)],
                     2010: [(1, 1), (1, 18), (2, 15), (4, 2), (5, 31), (7, 5), (9, 6), (11, 25), (12, 24)],
                     2011: [(1, 1), (1, 17), (2, 21), (4, 22), (5, 30), (7, 4), (9, 5), (11, 24), (12, 26)],
                     2012: [(1, 2), (1, 16), (2, 20), (4, 6), (5, 28), (7, 4), (9, 3), (10, 30), (11, 22), (12, 25)],
                     2013: [(1, 1), (1, 21), (2, 18), (3, 29), (5, 27), (7, 4), (9, 2), (11, 28), (12, 25)],
                     2014: [(1, 1), (1, 20), (2, 17), (4, 18), (5, 26), (7, 4), (9, 1), (11, 27), (12, 25)],
                     2015: [(1, 1), (1, 19), (2, 16), (4, 3), (5, 25), (7, 3), (9, 7), (11, 26), (12, 25)]}

        self.gblo = {
            # Whitsun, Last Mon Aug - http://hansard.millbanksystems.com/commons/1964/mar/04/staggered-holidays
            1965: [(4, 16), (4, 19), (6, 7), (8, 30), (12, 27), (12, 28)],
            # Whitsun May - http://hansard.millbanksystems.com/commons/1964/mar/04/staggered-holidays
            # 29th Aug - http://hansard.millbanksystems.com/written_answers/1965/nov/25/august-bank-holiday
            1966: [(4, 8), (4, 11), (5, 30), (8, 29), (12, 26), (12, 27)],
            # 29th May, 28th Aug - http://hansard.millbanksystems.com/written_answers/1965/jun/03/bank-holidays-1967-and-1968
            1967: [(3, 24), (3, 27), (5, 29), (8, 28), (12, 25), (12, 26)],
            # 3rd Jun, 2nd Sep - http://hansard.millbanksystems.com/written_answers/1965/jun/03/bank-holidays-1967-and-1968
            1968: [(4, 12), (4, 15), (6, 3), (9, 2), (12, 25), (12, 26)],
            # 26th May, 1st Sep - http://hansard.millbanksystems.com/written_answers/1967/mar/21/bank-holidays-1969-dates
            1969: [(4, 4), (4, 7), (5, 26), (9, 1), (12, 25), (12, 26)],
            # 25th May, 31st Aug - http://hansard.millbanksystems.com/written_answers/1967/jul/28/bank-holidays
            1970: [(3, 27), (3, 30), (5, 25), (8, 31), (12, 25), (12, 28)],
            # applying rules
            1971: [(4, 9), (4, 12), (5, 31), (8, 30), (12, 27), (12, 28)],
            2009: [(1, 1), (4, 10), (4, 13), (5, 4), (5, 25), (8, 31), (12, 25), (12, 28)],
            2010: [(1, 1), (4, 2), (4, 5), (5, 3), (5, 31), (8, 30), (12, 27), (12, 28)],
            # https://www.gov.uk/bank-holidays
            2012: [(1, 2), (4, 6), (4, 9), (5, 7), (6, 4), (6, 5), (8, 27), (12, 25), (12, 26)],
            2013: [(1, 1), (3, 29), (4, 1), (5, 6), (5, 27), (8, 26), (12, 25), (12, 26)],
            2014: [(1, 1), (4, 18), (4, 21), (5, 5), (5, 26), (8, 25), (12, 25), (12, 26)],
            2015: [(1, 1), (4, 3), (4, 6), (5, 4), (5, 25), (8, 31), (12, 25), (12, 28)],
            2016: [(1, 1), (3, 25), (3, 28), (5, 2), (5, 30), (8, 29), (12, 26), (12, 27)],
            2020: [(1, 1), (4, 10), (4, 13), (5, 8), (5, 25), (8, 31), (12, 25), (12, 28)],
            2022: [(1, 3), (4, 15), (4, 18), (5, 2), (6, 2), (6, 3), (8, 29), (9, 19), (12, 26), (12, 27)],
            2023: [(1, 2), (4, 7), (4, 10), (5, 1), (5, 8), (5, 29), (8, 28), (12, 25), (12, 26)]}

        self.euta = {  # 1997 - 1998(testing phase), Jan 1, christmas day
            1997: [(1, 1), (12, 25)],
            1998: [(1, 1), (12, 25)],
            # in 1999, Jan 1, christmas day, Dec 26, Dec 31
            1999: [(1, 1), (12, 25), (12, 31)],
            # in 2000, Jan 1, good friday, easter monday, May 1, christmas day, Dec 26
            2000: [(1, 1), (4, 21), (4, 24), (5, 1), (12, 25), (12, 26)],
            # in 2001, Jan 1, good friday, easter monday, May 1, christmas day, Dec 26, Dec 31
            2001: [(1, 1), (4, 13), (4, 16), (5, 1), (12, 25), (12, 26), (12, 31)],
            # from 2002, Jan 1, good friday, easter monday, May 1, christmas day, Dec 26
            2002: [(1, 1), (3, 29), (4, 1), (5, 1), (12, 25), (12, 26)],
            2003: [(1, 1), (4, 18), (4, 21), (5, 1), (12, 25), (12, 26)],
            # http: // www.ecb.europa.eu / home / html / holidays.en.html
            2014: [(1, 1), (4, 18), (4, 21), (5, 1), (12, 25), (12, 26)],
            2015: [(1, 1), (4, 3), (4, 6), (5, 1), (12, 25), (12, 26)]}

    def data(self):
        hl = getattr(self, self._type.name.lower())
        return hl


def test_cal(ct):
    data = CalData(ct).data()
    cal = HolidayCalendar(ct)

    offset = relativedelta(days=1)
    for yr in data:
        hl = {datetime.datetime(yr, x[0], x[1]) for x in data[yr]}
        dt = datetime.datetime(yr, 1, 1)

        assert cal.is_holiday(dt) != cal.is_businessday(dt)
        if cal.is_holiday(dt):
            assert dt in hl or dt.weekday() in (5, 6)
        else:
            assert dt not in hl

        dt += offset


def test_default_calendars():
    cal_types = [HolidayCalendarType.USNY, HolidayCalendarType.USGS, HolidayCalendarType.NYFD, HolidayCalendarType.NYSE,
                 HolidayCalendarType.GBLO, HolidayCalendarType.EUTA]
    for ct in cal_types:
        test_cal(ct)


if __name__ == '__main__':
    test_default_calendars()
